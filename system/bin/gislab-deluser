#!/bin/bash
# Author Ivan Mincik, GISTA s.r.o., ivan.mincik@gmail.com

set -e

# source configuration files
source /vagrant/config.cfg
if [ -f /vagrant/config-user.cfg ]
then
	source /vagrant/config-user.cfg
fi


# usage
function usage() {
	echo "USAGE: $(basename $0) [OPTIONS] username"
	echo "Delete GIS.lab user account."
	echo -e "\nOPTIONS
	-f  force running this command - do not ask before deleting account
	-h  display this help
	"
	exit 0
}


# options
FORCE="no"
while getopts "hf" OPTION
do
        case "$OPTION" in
			f) FORCE="yes" ;;
			h) usage ; exit 0 ;;
			\?) exit 1;;
        esac
done
shift $(($OPTIND - 1))
if [ $# -eq 0 ]; then usage; exit 0; fi

GISLAB_USER=$1

if [ "$FORCE" != "yes" ]; then
	echo "[GIS.lab]: You are going to delete user account '$GISLAB_USER'."
	echo "[GIS.lab]: This command will delete also all data belonging to this user. Continue ? [ENTER to continue, CTRL-C to cancel]"
	read
fi

# remove account
echo -e "\n[GIS.lab]: Removing GIS.lab user account ..."

# delete home
GISLAB_USER_HOME=$(ldapsearch -LLL -x -H ldapi:/// uid=$GISLAB_USER | grep homeDirectory | awk '{ print $2 }')

if [ -d "$GISLAB_USER_HOME" ]; then
	rm -rf $GISLAB_USER_HOME
fi

# manunaly delete user from additional groups (bug https://bugs.launchpad.net/ubuntu/+source/ldapscripts/+bug/1292143)
for GROUP in $(id -nG $GISLAB_USER | grep '[[:space:]]' | sed -r 's/^[^ ]* //'); do
	# check if GROUP is a system or LDAP group
	if ldapgid $GROUP >/dev/null 2>&1; then
		ldapdeleteuserfromgroup $GISLAB_USER $GROUP
	elif grep "^$GROUP:" /etc/group >/dev/null 2>&1; then
		deluser $GISLAB_USER $GROUP
	fi
done

ldapdeleteuser $GISLAB_USER # LDAP account

sudo su - postgres -c "psql -d gislab -c \"DROP SCHEMA $GISLAB_USER CASCADE\"" # PostgreSQL account
sudo su - postgres -c "psql -d gislab -c \"DROP OWNED BY $GISLAB_USER CASCADE\""
sudo su - postgres -c "dropuser $GISLAB_USER"

rm -rf /storage/share/$GISLAB_USER # NFS directory


echo -e "\n[GIS.lab]: Done."


# vim: set ts=4 sts=4 sw=4 noet:
